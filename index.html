<!DOCTYPE html>
<html>
  <head>
    <style>
       #map {
        height: 400px;
        width: 100%;
       }
    </style>
  </head>
  <body>
   
   <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdcdxoePGWaXQAC7IopbpCeQgM9MtPskc&callback=initMap">
   </script>
   <script src="/socket.io/socket.io.js"></script>


    <h3>My Google Maps Demo</h3>
    <div id="map"></div>
    <div class="panel-body" id="flig">
      <p>hola</p>
    </div>
    <p id='server-time'></p>
    <p id='aeropuertos'></p>
    <script>
      var $mapa;
      var $vuelos;
      var $marcadores_vuelos;
      var $aeropuertos;

      function initMap() {
        var uluru = {lat: -33.4372, lng: -70.6506};
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 8,
          center: uluru
        }); 
        var marker1 = new google.maps.Marker({
          position: {lat: -33.4372, lng: -70.6506},
          icon: {
            url: 'https://upload.wikimedia.org/wikipedia/commons/7/7d/Plane_icon.svg',
            scaledSize: {
              width:20,
              height:20
            }
          }
        });
        marker1.setMap(map);  
        map.addListener('click', function(e) {
          placeMarkerAndPanTo(e.latLng, map);
        });
        $mapa = map;     
      }

      function placeMarkerAndPanTo(latLng, map, lista) {
        var marker = new google.maps.Marker({
          position: latLng,
          map: map,
          icon: {
            url: 'https://upload.wikimedia.org/wikipedia/commons/7/7d/Plane_icon.svg',
            scaledSize: {
              width:20,
              height:20
            }
          }
        });
        
      }
      function updatepos(latLng, marker) {
        marker.setPosition(latLng);
        map.panTo(latLng);
      }
      
      console.log($mapa);
    </script>
    
    <script>
      var socket = io("wss://integracion-tarea-3.herokuapp.com", { "path" : "/flights" });
      var el = document.getElementById('server-time');
      var aer = document.getElementById('aeropuertos');
    
      socket.emit("AIRPORTS", {});
      socket.emit("FLIGHTS", {});


      var $aerop = [];

      const addAer = (data, options) => {
        data.forEach(function(element) {
          console.log(element);
        });
      }

      const addFlights = (data, options) => {
        data.forEach(function(element) {
          $aerop.push(element.code);
          $vuelos.push(element);
        });
        aer.innerHTML = $aerop;        
      }

      socket.on('POSITION', function(data) {
        el.innerHTML = 'Code: ' + data.code + ' Coordenates:' + data.position[0] + ', ' + data.position[1];
        placeMarkerAndPanTo({lat: data.position[0], lng: data.position[1]}, $mapa, $marcadores_vuelos);

      });
      socket.on('FLIGHTS', (data) => {
        addFlights(data);
      });
      socket.on('AIRPORTS', (data) => {
        addAer(data);
      })



    </script>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
  </body>
</html>