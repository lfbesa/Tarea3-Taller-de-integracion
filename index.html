<!DOCTYPE html>
<html>
  <head>
    <style>
       #map {
        height: 400px;
        width: 100%;
       }
    </style>
  </head>
  <body>
   
   
   <script src="/socket.io/socket.io.js"></script>


    <h3>Tarea 3 Taller de Integraci√≥n</h3>
    <h2>Felipe Besa</h2>
    <div id="map"></div>
    
    <p id='server-time'></p>
    <p id='aeropuertos'></p>
    <script>
      var $mapa;
      var vuelos=[];
      var aeropuertos=[];
      var marcadores_vuelos=[];
      var dic = {};

      function initMap() {
        var uluru = {lat: -33.4372, lng: -70.6506};
        var map = new google.maps.Map(document.getElementById('map'), {
          zoom: 8,
          center: uluru
        }); 
         
       
        $mapa = map;     
      }
      function placeflight(latLng, map, lista) {
        var marker = new google.maps.Marker({
          position: latLng,
          map: map,
          icon: {
            url: 'https://upload.wikimedia.org/wikipedia/commons/7/7d/Plane_icon.svg',
            scaledSize: {
              width:20,
              height:20
            }
          }
        });
        lista.push(marker);
      }
      function placeairport(latLng, map) {
        var marker = new google.maps.Marker({
          position: latLng,
          map: map,
          icon: 'https://developers.google.com/maps/documentation/javascript/examples/full/images/beachflag.png'
        });
      }
      function updatepos(latLng, marker, i){
        if (i > 2){
          drawline(marker.getPosition(), latLng, $mapa, '#FFFF00');
        }
        if (i>1){
        marker.setPosition(latLng);}
      }
      function drawline(latLng1, latLng2, map, color){
        var flightPath = new google.maps.Polyline({
          path: [latLng1, latLng2],
          geodesic: true,
          strokeColor: color,
          strokeOpacity: 1.0,
          strokeWeight: 3
        });
        flightPath.setMap(map);
      }
      
      console.log($mapa);
    </script>
    <script async defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCdcdxoePGWaXQAC7IopbpCeQgM9MtPskc&callback=initMap">
    </script>
    <script>
      var socket = io("wss://integracion-tarea-3.herokuapp.com", { "path" : "/flights" });
      var el = document.getElementById('server-time');
      var aer = document.getElementById('aeropuertos');
      var k = 0;
      



      const addFlights = (data, vuel, marca, dict) => {
        data.forEach(function(element) {
          var count=vuel.length;
          var a =1;
          for(var i=0;i<count;i++)
          {
            if(vuel[i]["code"]===element["code"]){a=0;}
          }
          if(a==1){
            dict[element["code"]] = marca.length;
            placeflight({lat: element["origin"]["airport_position"][0], lng: element["origin"]["airport_position"][1]}, $mapa, marca);
            vuel.push(element);

          }
        });
      }

      const addAer = (data, aer) => {
        // Don't fade the message in if there is an 'X was typing'
        for (var key in data) {
          var count=aer.length;
          var a =1;
          for(var i=0;i<count;i++)
          {
            if(aer[i]["airport_code"]===data[key]["airport_code"]){a=0;}
          }
          if(a==1){
            placeairport({lat: data[key]["airport_position"][0], lng: data[key]["airport_position"][1]}, $mapa);
            aer.push(data[key]);
            for (var j=0; j<aer.length-1;j++){
              drawline({lat: aer[j]["airport_position"][0], lng: aer[j]["airport_position"][1]} , {lat: data[key]["airport_position"][0], lng: data[key]["airport_position"][1]},$mapa, '#FF0000');
            }
          }
        }
      }

      socket.on('POSITION', function(data) {
        el.innerHTML = 'Code: ' + data.code + ' Coordenates:' + data.position[0] + ', ' + data.position[1];
        socket.emit("FLIGHTS", {});

        updatepos({lat: data.position[0], lng: data.position[1]}, marcadores_vuelos[dic[data.code]], k);
        k++;
        socket.emit("AIRPORTS", {});
        

      });
      socket.on('FLIGHTS', (data) => {
        addFlights(data, vuelos, marcadores_vuelos, dic);
      });
      socket.on('AIRPORTS', (data) => {
        addAer(data, aeropuertos);
      });


    </script>
    <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
  </body>
</html>